# Ancilla

**AI Assistant**

Ancilla is an AI-powered memory assistant that helps users save and retrieve todos through SMS messaging. Built with .NET Aspire, Azure Functions, and Azure Cosmos DB, it provides an intelligent, conversational interface for managing personal todos and information.

## Features

- ğŸ’¬ **SMS Interface** - Interact with your AI assistant via text messages using Twilio
- ğŸ§  **AI-Powered Conversations** - Powered by OpenAI GPT models with Semantic Kernel
- ğŸ“ **Todo Management** - Save, retrieve, and delete todos using natural language
- ğŸ” **Session Management** - Secure, per-user sessions with simple commands
- ğŸ“œ **Conversation History** - Maintains context across multiple interactions
- â˜ï¸ **Cloud Native** - Built with .NET Aspire for easy deployment to Azure
- ğŸ—„ï¸ **Scalable Storage** - Azure Cosmos DB for reliable, distributed data storage

## Architecture

Ancilla is built using modern cloud-native patterns:

- **Ancilla.AppHost** - .NET Aspire orchestration and infrastructure
- **Ancilla.FunctionApp** - Azure Functions for serverless HTTP endpoints
- **Ancilla.ServiceDefaults** - Shared service configuration and defaults

### Key Components

- **CommandInterceptor** - Handles special commands (`hello ancilla`, `goodbye ancilla`)
- **ChatService** - AI conversation management with OpenAI integration
- **TodoService** - CRUD operations for user todos in Cosmos DB
- **SessionService** - User session lifecycle management
- **HistoryService** - Conversation history persistence and retrieval
- **SmsService** - Twilio integration for SMS messaging

## Prerequisites

- [.NET 10.0 SDK](https://dotnet.microsoft.com/download/dotnet/10.0) or later
- [Azure subscription](https://azure.microsoft.com/free/) (for deployment)
- [Twilio account](https://www.twilio.com/) (for SMS functionality)
- [OpenAI API key](https://platform.openai.com/) or Azure OpenAI service

## Getting Started

### Local Development

1. **Clone the repository**
   ```bash
   git clone https://github.com/tombly/ancilla.git
   cd ancilla
   ```

2. **Configure user secrets**
   
   Navigate to the AppHost project and set your secrets:
   ```bash
   cd Ancilla.AppHost
   dotnet user-secrets set Parameters:openai-api-key "your-openai-api-key"
   dotnet user-secrets set Parameters:twilio-account-sid "your-twilio-account-sid"
   dotnet user-secrets set Parameters:twilio-auth-token "your-twilio-auth-token"
   dotnet user-secrets set Parameters:twilio-phone-number "your-twilio-phone-number"
   ```

3. **Update the resource group name**
   
   Edit `FixedNameInfrastructureResolver.cs` to set your Azure resource group name.

4. **Run locally**
   ```bash
   dotnet run --project Ancilla.AppHost
   ```

   The Aspire dashboard will launch, showing all running services and their endpoints.

### Deployment to Azure

1. **Configure infrastructure**
   
   The project uses .NET Aspire for infrastructure-as-code. Bicep templates generated by Aspire are generated in `Ancilla.AppHost/aspire-output/`.

2. **Deploy using Aspire**
   ```bash
   azd init
   azd up
   ```

   Aspire will prompt you for required secrets during deployment. You can easily grab them from the user secrets:
   ```bash
   cd Ancilla.AppHost
   dotnet user-secrets list | grep Parameters
   ```

3. **Post-deployment configuration**

   After deploying, grant your Entra principal the Contributor role for Cosmos DB so you can access Data Explorer and create the Cosmos DB database and containers:
   ```bash
   ./configure_cosmos.sh
   ```

## Usage

### Starting a Session

Send an SMS to your Twilio number:
```
hello ancilla
```

Response:
```
Welcome! I'm your AI memory assistant. I can help you save and retrieve todos via SMS. Try sending me a todo!
```

### Saving Todos

Simply send natural language messages:
```
Remember that my dentist appointment is next Tuesday at 2pm
```

```
Save a todo: buy milk, eggs, and bread
```

### Retrieving Todos

Ask for your todos in natural language:
```
What todos do I have?
```

```
List my todos
```

```
Do I have any appointments?
```

### Deleting Todos

Request deletion naturally:
```
Delete the todo about the dentist
```

```
Remove the grocery list
```

### Ending a Session

When you're done:
```
goodbye ancilla
```

Response:
```
Goodbye! Your session has been ended. Your todos have been preserved. Send 'hello ancilla' to start a new session.
```

## Configuration

### Environment Variables

The following environment variables are used (configured via user secrets in development):

- `Parameters:openai-api-key` - Your OpenAI API key
- `Parameters:twilio-account-sid` - Twilio account SID
- `Parameters:twilio-auth-token` - Twilio auth token
- `Parameters:twilio-phone-number` - Your Twilio phone number

## Project Structure

```
Ancilla/
â”œâ”€â”€ Ancilla.AppHost/           # Aspire orchestration
â”‚   â”œâ”€â”€ AppHost.cs             # Service definitions
â”‚   â”œâ”€â”€ aspire-output/         # Generated Bicep templates
â”‚   â””â”€â”€ FixedNameInfrastructureResolver.cs
â”œâ”€â”€ Ancilla.FunctionApp/       # Azure Functions app
â”‚   â”œâ”€â”€ CommandInterceptor.cs # Command handling
â”‚   â”œâ”€â”€ CosmosPlugin.cs        # Semantic Kernel plugin
â”‚   â”œâ”€â”€ IncomingMessage.cs     # HTTP message endpoint
â”‚   â”œâ”€â”€ IncomingSms.cs         # Twilio webhook endpoint
â”‚   â””â”€â”€ Services/              # Business logic services
â”‚       â”œâ”€â”€ ChatService.cs
â”‚       â”œâ”€â”€ HistoryService.cs
â”‚       â”œâ”€â”€ TodoService.cs
â”‚       â”œâ”€â”€ SessionService.cs
â”‚       â””â”€â”€ SmsService.cs
â””â”€â”€ Ancilla.ServiceDefaults/   # Shared configuration
```

## Data Model

### Sessions
- Partitioned by `agentPhoneNumber`
- Tracks active user sessions
- Stores user timezone preferences

### Todos
- Partitioned by `agentPhoneNumber`
- Associated with `userPhoneNumber`
- Supports soft deletion
- Preserved when sessions end

### History
- Partitioned by `agentPhoneNumber`
- Maintains conversation context
- One entry per user message and AI response

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

**Made with â¤ï¸ using .NET Aspire**
